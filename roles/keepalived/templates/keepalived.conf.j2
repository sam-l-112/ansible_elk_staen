### NOTICE: This file is auto-generated by ansible, DO NOT edit this file manually!

! Configuration File for keepalived

global_defs {
        router_id {{ keepalived.router_id }}
	script_user root
	enable_script_security
{% if keepalived.notification_email is defined %}
	notification_email {
{% for _email in keepalived.notification_email %}
                {{ _email }}{% if not loop.last %},{% endif %}

{% endfor %}
	}
	notification_email_from {{ global.smtp.from_address }}
	smtp_server {{ global.smtp.host }} {{ global.smtp.port }}
	smtp_connect_timeout 30
{% endif %}
}

vrrp_script {{ keepalived.vrrp_script.name }} {
        script "{{ keepalived.vrrp_script.script }}"
        interval 2
}

{% if keepalived.vrrp_instance is defined %}
{% for _vlan in keepalived.vrrp_instance|list %}
{% set _interface = vars['keepalived']['vrrp_instance'][_vlan]['nic'] %}
{% set _json_list = vars['keepalived']['vrrp_instance'][_vlan]['vips'][ansible_hostname] %}
{% set _ip = hostvars[inventory_hostname]['ansible_' + _interface]['ipv4']['address'] %}
{% for _json in _json_list %}
vrrp_instance {{ _vlan }}_{{ _json.id }} {
	state {{ _json.state }}
        interface {{ _interface }}
        virtual_router_id {{ _json.id }}
        priority {{ _json.priority }}
        unicast_src_ip {{ _ip }}
        unicast_peer { 
		{{ groups[_vlan] | map('extract', hostvars, ['inventory_hostname']) | difference(_ip) | join('\n		') }} 
	}
        virtual_ipaddress {
		{{ _json.ip }}
        }
	authentication {
		auth_type PASS
		auth_pass {{ vars['keepalived']['vrrp_instance'][_vlan]['password'] }}
	}
        track_script {
                {{ keepalived.vrrp_script.name }} weight -{{ groups[_vlan] | length }}
        }
	advert_int 1
{% if keepalived.notification_email is defined %}
	smtp_alert
{% endif %}
}

{% endfor %}
{% endfor %}
{% endif %}
