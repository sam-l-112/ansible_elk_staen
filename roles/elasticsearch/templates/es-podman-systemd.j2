{% set _total = elasticsearch.containers|length %}
{% set _memory_gb = (((ansible_memtotal_mb * 0.6)/_total)/1024) | int  %}
{% if _memory_gb > 32 %}
{% set _memory_gb = 32 %}
{% endif %}
{% set _ip = ansible_all_ipv4_addresses | intersect(groups[syslog_global.cluster_group]) %}
### NOTICE: This file is auto-generated by ansible, DO NOT edit this file manually!

[Unit]
Description=Podman container-{{ item.name }}.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman run \
	--cidfile=%t/%n.ctr-id \
	--cgroups=no-conmon \
	--rm \
	--sdnotify=conmon \
	--replace \
	--name={{ item.name }} \
	-d \
	-e node.name={{ ansible_facts['nodename'] }}-{{ item.name }} \
	-e discovery.seed_hosts={{ groups[syslog_global.cluster_group] | map('extract', hostvars, ['inventory_hostname']) | join(':9300,') }}:9300 \
	-e cluster.initial_master_nodes={{ groups[syslog_global.cluster_group] | map('extract', hostvars, ['inventory_hostname']) | join(':9300,') }}:9300 \
	-e cluster.name={{ elasticsearch.cluster_name }} \
	-e bootstrap.memory_lock=true \
	-e http.port={{ item.http_port }} \
	-e transport.port={{ item.transport_port }} \
	-e node.roles="{{ item.role }}" \
	-e network.host={{ _ip[0] }} \
	-e node.attr.rack_id={{ ansible_facts['nodename'] }} \
	-e cluster.routing.allocation.awareness.attributes=rack_id \
	-e transport.compress=false \
	-e xpack.ml.enabled=false \
	-e xpack.security.enabled=false \
	-e xpack.monitoring.enabled=true \
	-e xpack.monitoring.collection.enabled=true \
	-e xpack.monitoring.history.duration=14d \
	-e xpack.license.self_generated.type=basic \
	-e "ES_JAVA_OPTS=-Xms{{ _memory_gb }}g -Xmx{{ _memory_gb }}g" \
	-v /etc/hosts:/etc/hosts \
	-v /data/{{ item.name }}:/usr/share/elasticsearch/data \
	--network host \
	--log-driver=journald \
	--hostname {{ ansible_facts['nodename'] }}-{{ item.name }} \
	--ulimit memlock=-1:-1 \
	--ulimit nofile=65535:65535 localhost/elasticsearch:latest
ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
